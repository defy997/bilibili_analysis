# 托盘问题调试指南

## 🐛 已知问题

1. **托盘图标不显示**
2. **Close 按钮没反应**

---

## 🔍 调试步骤

### 步骤1：测试托盘功能

运行测试脚本：
```bash
cd electron
npx electron test-tray.js
```

如果看到托盘图标，说明 Electron 托盘功能正常。

---

### 步骤2：检查控制台日志

启动主应用后，查看控制台是否有以下日志：
- `开始创建系统托盘...`
- `✅ 系统托盘创建成功`

---

### 步骤3：检查 Close 按钮

在控制台查看是否有：
- `收到关闭窗口请求`

---

## 🔧 快速修复方案

### 修复1：简化托盘创建代码

在 `main.js` 的 `createTray()` 函数中，替换为以下代码：

```javascript
function createTray() {
  console.log('创建托盘...');

  // Windows 上使用 ICO 文件效果最好
  // 如果没有 ICO 文件，使用简单的 PNG
  const iconPath = path.join(__dirname, 'assets', 'icon.ico');
  const fs = require('fs');

  let icon;
  if (fs.existsSync(iconPath)) {
    icon = nativeImage.createFromPath(iconPath);
  } else {
    // 使用简单的图标
    const { createCanvas } = require('canvas');
    const canvas = createCanvas(16, 16);
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ec4899';
    ctx.fillRect(0, 0, 16, 16);
    icon = nativeImage.createFromDataURL(canvas.toDataURL());
  }

  tray = new Tray(icon);
  tray.setToolTip('BiliMood');

  const menu = Menu.buildFromTemplate([
    { label: '显示', click: () => { if(mainWindow) mainWindow.show(); } },
    { label: '退出', click: () => { app.isQuitting = true; app.quit(); } }
  ]);

  tray.setContextMenu(menu);
  console.log('✅ 托盘创建完成');
}
```

---

### 修复2：确保 app.isQuitting 初始化

在 `main.js` 顶部添加：

```javascript
// 在文件开头，变量声明部分添加
app.isQuitting = false;
```

---

### 修复3：测试用图标

创建一个简单的 16x16 粉色方块作为托盘图标。

在 PowerShell 中运行：
```powershell
# 安装 canvas 模块（如果需要）
npm install canvas

# 创建简单的测试图标
node -e "
const fs = require('fs');
const { createCanvas } = require('canvas');
const canvas = createCanvas(16, 16);
const ctx = canvas.getContext('2d');
ctx.fillStyle = '#ec4899';
ctx.beginPath();
ctx.arc(8, 8, 6, 0, Math.PI * 2);
ctx.fill();
fs.mkdirSync('assets', { recursive: true });
fs.writeFileSync('assets/tray-icon.png', canvas.toBuffer('image/png'));
console.log('图标创建成功');
"
```

---

## ⚙️ 完整的最小化配置

如果以上方法都不行，创建一个最小化的 `main-minimal.js`:

```javascript
const { app, BrowserWindow, Tray, Menu, nativeImage } = require('electron');
const path = require('path');

let mainWindow;
let tray;

app.isQuitting = false;

app.whenReady().then(() => {
  // 创建窗口
  mainWindow = new BrowserWindow({
    width: 800,
    height: 600,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false
    }
  });

  mainWindow.loadFile('src/index.html');

  // 创建托盘
  const iconPath = path.join(__dirname, 'assets', 'tray-icon.png');
  let icon;

  try {
    icon = nativeImage.createFromPath(iconPath);
    if (icon.isEmpty()) throw new Error();
  } catch {
    // 使用内置图标
    icon = nativeImage.createFromDataURL(
      'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAdgAAAHYBTnsmCAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAE8SURBVDiNpZMxS8NAGIafL5fLJU1Mm9pUEBwEFRdx6ODg4OLg4ODgH3Bwc3BxcHBwcHBwcBAEB0FBEBQUxKGDg4ODg4ODIDhUcGiapkmT5nK5y+XSRRGk+Lbve9/vPb77voO/jPwVME0TwzAwDAO/34+iKGiahmVZ2LaNbdtYloVt2+i6jq7rAMiyTFVV1W7g8XhQFIWqqiqKoqgoioKu6ziOg+M42LaNZVnYto1lWdi2zenpKel0GkBXVVW9v7+n1Wqxvr7O0tISy8vLbGxssLm5yfb2NltbW+zs7LC3t8fh4SHn5+dcXV1xc3NDNptlYGCA+fl5xsfHmZubY2ZmhqmpKSYnJ5mYmGB8fJyxsTFGR0cZGRlheHiYoaEhBgcH6e/vp6+vj97eXnp6eujs7KSjo4P29nba2tpobm6msbGRuro66uvrv60gyzKqqpJOp3+tAODkX+Uzfng5s1Qgka4AAAAASUVORK5CYII='
    );
  }

  tray = new Tray(icon);
  tray.setToolTip('BiliMood');

  const menu = Menu.buildFromTemplate([
    {
      label: '显示',
      click: () => {
        mainWindow.show();
      }
    },
    {
      label: '退出',
      click: () => {
        app.isQuitting = true;
        app.quit();
      }
    }
  ]);

  tray.setContextMenu(menu);

  tray.on('click', () => {
    if (mainWindow.isVisible()) {
      mainWindow.hide();
    } else {
      mainWindow.show();
    }
  });

  // 窗口关闭时隐藏而不是退出
  mainWindow.on('close', (e) => {
    if (!app.isQuitting) {
      e.preventDefault();
      mainWindow.hide();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});
```

---

## 🎯 推荐的修复步骤

1. 在 `main.js` 顶部添加 `app.isQuitting = false;`
2. 运行测试脚本确认托盘功能正常
3. 检查控制台日志
4. 如果还不行，使用最小化配置

---

## 📝 常见原因

1. **图标格式问题** - Windows 推荐使用 .ico 格式
2. **图标尺寸问题** - 必须是 16x16 或 32x32
3. **app.isQuitting 未初始化** - 导致窗口关闭逻辑错误
4. **IPC 事件名称不匹配** - 前后端事件名必须一致

---

最后更新：2026-01-29
