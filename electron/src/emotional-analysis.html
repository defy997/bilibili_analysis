<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotional Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent;
        }
        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }
        /* 拖拽区域样式 */
        .drag-area {
            -webkit-app-region: drag;
            cursor: grab;
        }
        .drag-area:active {
            cursor: grabbing;
        }
        /* 防止按钮被拖拽 */
        .no-drag {
            -webkit-app-region: no-drag;
        }
        /* 自定义滚动条样式 */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: rgba(244, 114, 182, 0.3);
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: rgba(244, 114, 182, 0.5);
        }
    </style>
</head>
<body class="h-full w-full text-white overflow-hidden">

    <!-- 情感分析主容器 -->
    <div class="h-full w-full flex flex-col">
        
        <!-- 顶部标题栏 (拖拽区域) -->
        <div class="h-12 flex items-center justify-between px-4 border-b border-white/10 bg-white/5 flex-shrink-0 drag-area select-none">
            <!-- 左侧：返回按钮 + 标题 -->
            <div class="flex items-center gap-3">
                <button onclick="goBack()" class="text-white/60 hover:text-white transition-colors no-drag" title="Go back" aria-label="Go back">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400">
                        <i class="fa-solid fa-heart-crack"></i>
                    </div>
                    <span class="font-bold tracking-wide">Emotional Analysis</span>
                </div>
            </div>
            
            <!-- 右侧：操作按钮 -->
            <div class="flex items-center gap-3 no-drag text-xs">
                <button onclick="refreshData()" class="text-white/60 hover:text-white transition-colors" title="Refresh data" aria-label="Refresh data">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button onclick="closeModule()" class="text-white/60 hover:text-pink-400 transition-colors" title="Close" aria-label="Close">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="flex-1 w-full p-6 overflow-y-auto">

            <!-- 加载中提示 -->
            <div id="loading-indicator" class="hidden glass-panel rounded-2xl p-8 mb-6 text-center">
                <div class="flex flex-col items-center gap-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-pink-500 border-t-transparent"></div>
                    <div class="text-lg font-semibold" id="loading-title">Analyzing video...</div>
                    <div class="text-sm text-white/60" id="loading-subtitle">This may take a few moments</div>
                    <!-- 进度条 -->
                    <div class="w-full max-w-xs bg-white/10 rounded-full h-2 mt-2">
                        <div id="loading-progress" class="bg-pink-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <!-- 任务状态 -->
                    <div id="loading-tasks" class="text-xs text-white/40 space-y-1 hidden">
                        <div class="flex items-center justify-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
                            <span>Comments: pending</span>
                        </div>
                        <div class="flex items-center justify-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
                            <span>Danmu: pending</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 视频信息卡片 -->
            <div class="glass-panel rounded-2xl p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 id="video-title" class="font-bold text-lg">Waiting for video...</h3>
                        <p id="video-bvid" class="text-white/40 text-xs font-mono mt-1">--</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-pink-400" id="total-comments">0</div>
                        <div class="text-xs text-white/40">Total Comments</div>
                    </div>
                </div>
            </div>

            <!-- 情感分布饼图 -->
            <div class="glass-panel rounded-2xl p-6 mb-6">
                <h4 class="text-sm font-bold uppercase tracking-wider text-white/60 mb-4">Sentiment Distribution</h4>
                <div id="pie-chart" class="w-full h-64"></div>
            </div>

            <!-- 统计卡片网格 -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <!-- 正面 -->
                <div class="stat-card glass-panel rounded-2xl p-4 border-l-4 border-green-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
                            <i class="fa-solid fa-thumbs-up"></i>
                        </div>
                        <span class="text-xs text-white/60 uppercase">Positive</span>
                    </div>
                    <div class="text-3xl font-bold text-green-400" id="positive-count">0</div>
                    <div class="text-xs text-white/40 mt-1" id="positive-percent">0%</div>
                </div>

                <!-- 中性 -->
                <div class="stat-card glass-panel rounded-2xl p-4 border-l-4 border-gray-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-gray-500/20 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-minus"></i>
                        </div>
                        <span class="text-xs text-white/60 uppercase">Neutral</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-400" id="neutral-count">0</div>
                    <div class="text-xs text-white/40 mt-1" id="neutral-percent">0%</div>
                </div>

                <!-- 负面 -->
                <div class="stat-card glass-panel rounded-2xl p-4 border-l-4 border-pink-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400">
                            <i class="fa-solid fa-heart-crack"></i>
                        </div>
                        <span class="text-xs text-white/60 uppercase">Negative</span>
                    </div>
                    <div class="text-3xl font-bold text-pink-400" id="negative-count">0</div>
                    <div class="text-xs text-white/40 mt-1" id="negative-percent">0%</div>
                </div>
            </div>

            <!-- 情感趋势图 -->
            <div class="glass-panel rounded-2xl p-6 mb-6">
                <h4 class="text-sm font-bold uppercase tracking-wider text-white/60 mb-4">Sentiment Trend</h4>
                <div id="trend-chart" class="w-full h-48"></div>
            </div>

            <!-- 24小时评论分布 -->
            <div class="glass-panel rounded-2xl p-6 mb-6">
                <h4 class="text-sm font-bold uppercase tracking-wider text-white/60 mb-4">24-Hour Comment Distribution</h4>
                <div id="hourly-chart" class="w-full h-64"></div>
            </div>

            <!-- 弹幕时间轴热力图 -->
            <div class="glass-panel rounded-2xl p-6 mb-6">
                <h4 class="text-sm font-bold uppercase tracking-wider text-white/60 mb-4">Danmu Timeline Heatmap</h4>
                <div id="danmu-heatmap" class="w-full h-64"></div>
            </div>

            <!-- 高赞评论Top20 -->
            <div class="glass-panel rounded-2xl p-6 mb-6">
                <h4 class="text-sm font-bold uppercase tracking-wider text-white/60 mb-4">Top 20 Comments by Likes</h4>
                <div id="top-comments" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>

        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let pieChart = null;
        let trendChart = null;
        let hourlyChart = null;
        let danmuHeatmapChart = null;
        let currentBvId = null;

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            listenForVideoChange();
            loadThemeFromConfig();

            // 按 Ctrl+Shift+O 打开开发者工具调试
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'O') {
                    ipcRenderer.send('open-devtools', 'analysis');
                }
            });
        });

        // === 初始化图表 ===
        function initCharts() {
            // 饼图
            const pieDom = document.getElementById('pie-chart');
            pieChart = echarts.init(pieDom);
            pieChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'item' },
                legend: {
                    bottom: '0%',
                    left: 'center',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '45%'],
                    itemStyle: { borderRadius: 8, borderColor: 'rgba(20,20,30,0.8)', borderWidth: 2 },
                    label: { show: false },
                    data: [
                        { value: 0, name: 'Positive', itemStyle: { color: '#4ade80' } },
                        { value: 0, name: 'Neutral', itemStyle: { color: '#94a3b8' } },
                        { value: 0, name: 'Negative', itemStyle: { color: '#f472b6' } }
                    ]
                }]
            });

            // 趋势图
            const trendDom = document.getElementById('trend-chart');
            trendChart = echarts.init(trendDom);
            trendChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                legend: { bottom: '0%', textStyle: { color: '#fff' } },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '5%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#888', rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888' }
                },
                series: [
                    {
                        name: 'Positive',
                        data: [],
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: '#4ade80' },
                        itemStyle: { color: '#4ade80' }
                    },
                    {
                        name: 'Neutral',
                        data: [],
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: '#94a3b8' },
                        itemStyle: { color: '#94a3b8' }
                    },
                    {
                        name: 'Negative',
                        data: [],
                        type: 'line',
                        smooth: true,
                        lineStyle: { color: '#f472b6' },
                        itemStyle: { color: '#f472b6' }
                    }
                ]
            });

            // 24小时分布图
            const hourlyDom = document.getElementById('hourly-chart');
            hourlyChart = echarts.init(hourlyDom);
            hourlyChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: Array.from({length: 24}, (_, i) => i + 'h'),
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#888' }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888' }
                },
                series: [{
                    data: Array(24).fill(0),
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#f472b6' },
                            { offset: 1, color: '#ec4899' }
                        ])
                    }
                }]
            });

            // 弹幕时间轴热力图
            const danmuDom = document.getElementById('danmu-heatmap');
            danmuHeatmapChart = echarts.init(danmuDom);
            danmuHeatmapChart.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `时间: ${data.name}<br/>弹幕数: ${data.value}`;
                    }
                },
                grid: { left: '3%', right: '8%', bottom: '15%', top: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: {
                        color: '#888',
                        interval: 'auto',
                        rotate: 45,
                        fontSize: 10,
                        formatter: function(value) {
                            // 保留原始格式
                            return value;
                        }
                    },
                    name: '视频时间',
                    nameLocation: 'middle',
                    nameGap: 25,
                    nameTextStyle: { color: '#888', fontSize: 12 }
                },
                yAxis: {
                    type: 'value',
                    name: '弹幕数量',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888' }
                },
                visualMap: {
                    show: true,
                    min: 0,
                    max: 100,
                    calculable: true,
                    orient: 'vertical',
                    right: '2%',
                    top: 'center',
                    itemHeight: 150,
                    textStyle: { color: '#fff', fontSize: 10 },
                    inRange: {
                        color: ['#4ade80', '#22c55e', '#eab308', '#f97316', '#ef4444']
                    }
                },
                series: [{
                    data: [],
                    type: 'bar',
                    barWidth: '80%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            });
        }

        // === 监听视频切换信号 ===
        function listenForVideoChange() {
            ipcRenderer.on('video-change', (event, bvId) => {
                console.log('收到视频信号:', bvId);
                currentBvId = bvId;
                loadData(bvId);
            });
        }

        // === 加载数据 ===
        async function loadData(bvId) {
            try {
                // 显示加载指示器
                showLoading(true);

                // 1. 先尝试触发异步分析
                try {
                    const analyzeResp = await fetch(`http://118.25.39.91:8000/api/video/async-analyze/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bvid: bvId })
                    });
                    const analyzeData = await analyzeResp.json();

                    if (analyzeData.success && analyzeData.status === 'processing') {
                        // 有任务在进行中，开始轮询
                        console.log('[LoadData] 异步任务已提交，开始轮询:', analyzeData.tasks);
                        await pollAnalysisTasks(analyzeData.tasks, bvId);
                        return; // 轮询完成后会自动加载 dashboard
                    } else if (analyzeData.status === 'cached') {
                        console.log('[LoadData] 数据已缓存');
                        // 继续加载 dashboard
                    } else if (analyzeData.status === 'already_processing') {
                        console.log('[LoadData] 视频正在被其他请求处理');
                    }
                } catch (analyzeErr) {
                    console.warn('[LoadData] 异步分析触发失败，回退同步:', analyzeErr);
                    // 继续尝试同步加载
                }

                // 2. 调用 dashboard API
                const response = await fetch(`http://118.25.39.91:8000/api/video/dashboard/${bvId}/`);
                const data = await response.json();

                // 隐藏加载指示器
                showLoading(false);

                if (data.success) {
                    updateUI(data);
                } else {
                    console.error('数据加载失败:', data.error);
                    showError(data.error);
                }
            } catch (error) {
                showLoading(false);
                console.error('加载数据失败:', error);
                showError('Failed to load data: ' + error.message);
            }
        }

        // === 轮询分析任务状态 ===
        async function pollAnalysisTasks(tasks, bvId) {
            const taskIds = Object.values(tasks).map(t => t.task_id);
            const pollInterval = 2000; // 2秒轮询一次
            const maxAttempts = 60; // 最多轮询60次（2分钟）
            let attempts = 0;

            // 显示任务状态
            const loadingTasks = document.getElementById('loading-tasks');
            const loadingProgress = document.getElementById('loading-progress');
            const loadingTitle = document.getElementById('loading-title');
            const loadingSubtitle = document.getElementById('loading-subtitle');

            if (loadingTasks) loadingTasks.classList.remove('hidden');
            if (loadingProgress) {
                loadingProgress.style.width = '10%';
                loadingProgress.classList.add('animate-pulse');
            }

            const pollTimer = setInterval(async () => {
                attempts++;

                try {
                    const resp = await fetch(`http://118.25.39.91:8000/api/video/task-status/?task_ids=${taskIds.join(',')}`);
                    const data = await resp.json();

                    if (data.success && data.tasks) {
                        // 更新进度
                        const completed = Object.values(data.tasks).filter(t => t.status === 'completed').length;
                        const total = Object.keys(data.tasks).length;
                        const progress = Math.round((completed / total) * 80) + 10; // 10% ~ 90%

                        if (loadingProgress) loadingProgress.style.width = `${progress}%`;
                        if (loadingTitle) loadingTitle.innerText = `Analyzing... ${completed}/${total}`;

                        // 更新任务状态
                        for (const [type, task] of Object.entries(tasks)) {
                            const taskStatus = data.tasks[task.task_id];
                            const taskEl = loadingTasks?.querySelectorAll('span:last-child');
                            if (taskEl) {
                                for (const el of taskEl) {
                                    if (el.textContent.toLowerCase().includes(type)) {
                                        if (taskStatus?.status === 'completed') {
                                            el.innerHTML = `<span class="text-green-400">${type}: completed (${taskStatus.result?.count || 0} items)</span>`;
                                        } else {
                                            el.innerHTML = `<span class="text-yellow-400 animate-pulse">${type}: processing...</span>`;
                                        }
                                    }
                                }
                            }
                        }

                        // 检查是否全部完成
                        let allCompleted = true;
                        let hasError = false;

                        for (const taskId of taskIds) {
                            const taskStatus = data.tasks[taskId];
                            if (!taskStatus || taskStatus.status !== 'completed') {
                                allCompleted = false;
                                break;
                            }
                            if (taskStatus.result?.error) {
                                hasError = true;
                            }
                        }

                        if (allCompleted) {
                            clearInterval(pollTimer);

                            if (loadingProgress) {
                                loadingProgress.style.width = '100%';
                                loadingProgress.classList.remove('animate-pulse');
                                loadingProgress.classList.add('bg-green-500');
                            }
                            if (loadingTitle) loadingTitle.innerText = 'Analysis Complete!';
                            if (loadingSubtitle) {
                                if (data.summary) {
                                    loadingSubtitle.innerText = `${data.summary.total_count} items processed (pos: ${data.summary.positive_count}, neg: ${data.summary.negative_count})`;
                                } else {
                                    loadingSubtitle.innerText = 'All tasks completed';
                                }
                            }

                            // 延迟一点后加载 dashboard
                            setTimeout(async () => {
                                if (loadingTasks) loadingTasks.classList.add('hidden');
                                showLoading(false);
                                // 重新加载 dashboard
                                await loadDashboard(bvId);
                            }, 1500);
                        }

                        // 超时处理
                        if (attempts >= maxAttempts) {
                            clearInterval(pollTimer);
                            console.warn('[PollTasks] 轮询超时');
                            if (loadingTitle) loadingTitle.innerText = 'Timeout';
                            if (loadingSubtitle) loadingSubtitle.innerText = 'Taking longer than expected, showing available data...';
                            setTimeout(async () => {
                                if (loadingTasks) loadingTasks.classList.add('hidden');
                                showLoading(false);
                                await loadDashboard(bvId);
                            }, 2000);
                        }
                    }
                } catch (err) {
                    console.error('[PollTasks] 轮询错误:', err);
                    attempts++; // 超时计数
                    if (attempts >= maxAttempts) {
                        clearInterval(pollTimer);
                        if (loadingTasks) loadingTasks.classList.add('hidden');
                        showLoading(false);
                        await loadDashboard(bvId);
                    }
                }
            }, pollInterval);
        }

        // === 加载 Dashboard 数据 ===
        async function loadDashboard(bvId) {
            try {
                const response = await fetch(`http://118.25.39.91:8000/api/video/dashboard/${bvId}/`);
                const data = await response.json();

                if (data.success) {
                    updateUI(data);
                } else {
                    console.error('Dashboard 加载失败:', data.error);
                    showError(data.error);
                }
            } catch (error) {
                console.error('Dashboard 加载失败:', error);
                showError('Failed to load dashboard: ' + error.message);
            }
        }

        // === 显示/隐藏加载指示器 ===
        function showLoading(show) {
            const loader = document.getElementById('loading-indicator');
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        // === 显示错误信息 ===
        function showError(message) {
            // 可以在这里添加错误提示UI
            console.error('Error:', message);
        }

        // === 更新界面 ===
        function updateUI(data) {
            console.log('开始更新UI，数据：', data);

            try {
                // 更新标题
                document.getElementById('video-title').innerText = data.video_info?.title || 'Unknown';
                document.getElementById('video-bvid').innerText = currentBvId || '';
                // 更新统计
                const pos = data.sentiment.distribution.positive;
                const neu = data.sentiment.distribution.neutral;
                const neg = data.sentiment.distribution.negative;
                const total = pos + neu + neg;
                document.getElementById('total-comments').innerText = total;
                document.getElementById('positive-count').innerText = pos;
                document.getElementById('neutral-count').innerText = neu;
                document.getElementById('negative-count').innerText = neg;
                document.getElementById('positive-percent').innerText = total ? Math.round(pos/total*100) + '%' : '0%';
                document.getElementById('neutral-percent').innerText = total ? Math.round(neu/total*100) + '%' : '0%';
                document.getElementById('negative-percent').innerText = total ? Math.round(neg/total*100) + '%' : '0%';
                // 更新饼图
                pieChart.setOption({
                    series: [{ data: [
                        { value: pos, name: 'Positive' },
                        { value: neu, name: 'Neutral' },
                        { value: neg, name: 'Negative' }
                    ]}]
                });

                console.log('开始更新情感趋势图');
                // 更新情感趋势图
                updateTrendChart(data.sentiment.trend_by_time);

                console.log('开始更新24小时分布');
                // 更新24小时分布
                updateHourlyChart(data.time_analysis.hourly_distribution);

                console.log('开始更新弹幕时间轴');
                // 更新弹幕时间轴
                updateDanmuHeatmap(data.danmu.timeline_heatmap);

                console.log('开始更新高赞评论');
                // 更新高赞评论列表
                updateTopComments(data.quality.top_comments);

                console.log('UI更新完成');
            } catch (error) {
                console.error('更新UI时出错:', error);
            }
        }

        // === 更新情感趋势图 ===
        function updateTrendChart(trendData) {
            if (!trendData || trendData.length === 0) {
                return;
            }

            const timeLabels = trendData.map(item => {
                // 格式化时间标签 "2024-01-15 10:00" -> "01-15 10:00"
                const parts = item.time.split(' ');
                return parts.length > 1 ? parts[0].slice(5) + ' ' + parts[1] : item.time;
            });

            const positiveData = trendData.map(item => item.positive);
            const neutralData = trendData.map(item => item.neutral);
            const negativeData = trendData.map(item => item.negative);

            trendChart.setOption({
                xAxis: { data: timeLabels },
                series: [
                    { data: positiveData },
                    { data: neutralData },
                    { data: negativeData }
                ]
            });
        }

        // === 更新24小时分布图 ===
        function updateHourlyChart(hourlyData) {
            if (!hourlyData || hourlyData.length === 0) {
                return;
            }

            const counts = Array(24).fill(0);
            hourlyData.forEach(item => {
                if (item.hour >= 0 && item.hour < 24) {
                    counts[item.hour] = item.count;
                }
            });

            hourlyChart.setOption({
                series: [{ data: counts }]
            });
        }

        // === 更新弹幕时间轴热力图 ===
        function updateDanmuHeatmap(heatmapData) {
            if (!heatmapData || heatmapData.length === 0) {
                danmuHeatmapChart.setOption({
                    title: {
                        text: '暂无弹幕数据\n可能原因：视频未爬取弹幕或弹幕数据为空',
                        left: 'center',
                        top: 'center',
                        textStyle: {
                            color: '#fff',
                            opacity: 0.4,
                            fontSize: 14,
                            fontWeight: 'normal',
                            lineHeight: 20
                        }
                    },
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                }, true); // true 表示不合并，完全替换
                return;
            }

            // 只取前50个点，避免标签过于密集
            const maxPoints = 50;
            const displayData = heatmapData.length > maxPoints ? heatmapData.slice(0, maxPoints) : heatmapData;

            const timeLabels = displayData.map(item => {
                // 转换秒为分:秒格式
                const minutes = Math.floor(item.time / 60);
                const seconds = Math.floor(item.time % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });

            const counts = displayData.map(item => item.count);
            const maxCount = Math.max(...counts);

            // 计算显示间隔
            const totalLabels = timeLabels.length;
            const interval = totalLabels > 20 ? Math.ceil(totalLabels / 10) : 'auto';

            danmuHeatmapChart.setOption({
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: {
                        interval: interval,
                        rotate: totalLabels > 15 ? 45 : 0,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888' }
                },
                visualMap: {
                    min: 0,
                    max: maxCount,
                    show: true,
                    orient: 'vertical',
                    right: '2%',
                    top: 'center',
                    itemHeight: 120,
                    textStyle: { color: '#fff', fontSize: 10 },
                    inRange: {
                        color: ['#4ade80', '#22c55e', '#eab308', '#f97316', '#ef4444']
                    }
                },
                series: [{
                    data: counts,
                    type: 'bar',
                    barWidth: '80%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            }, true); // 不合并，完全替换之前的配置
        }

        // === 更新高赞评论列表 ===
        function updateTopComments(comments) {
            const container = document.getElementById('top-comments');

            if (!comments || comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-comments text-2xl text-white/20"></i>
                        </div>
                        <div class="text-white/40 text-sm mb-2">暂无评论数据</div>
                        <div class="text-white/20 text-xs">可能原因：视频未爬取评论或评论数据为空</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = comments.map((comment, index) => {
                const sentimentColor = comment.sentiment_label === 'positive' ? 'green' :
                                      comment.sentiment_label === 'negative' ? 'pink' : 'gray';

                return `
                    <div class="glass-panel rounded-xl p-4 hover:bg-white/10 transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-white/40 font-mono text-xs">#${index + 1}</span>
                                <span class="text-white/80 font-semibold text-sm">${comment.uname || 'Anonymous'}</span>
                                <span class="px-2 py-0.5 rounded-full text-xs bg-${sentimentColor}-500/20 text-${sentimentColor}-400">
                                    ${comment.sentiment_label}
                                </span>
                            </div>
                            <div class="flex items-center gap-1 text-pink-400">
                                <i class="fa-solid fa-thumbs-up text-xs"></i>
                                <span class="font-bold">${comment.like_count}</span>
                            </div>
                        </div>
                        <p class="text-white/90 text-sm mb-2 line-clamp-3">${comment.message}</p>
                        <div class="flex items-center gap-3 text-xs text-white/40">
                            <span><i class="fa-regular fa-clock"></i> ${comment.ctime || 'N/A'}</span>
                            <span>Quality: ${(comment.quality_score * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === 返回导航页 ===
        function goBack() {
            // 隐藏当前窗口
            ipcRenderer.send('close-analysis-window');
        }

        // === 关闭模块 ===
        function closeModule() {
            // 隐藏当前窗口
            ipcRenderer.send('close-analysis-window');
        }

        // === 刷新数据 ===
        function refreshData() {
            if (currentBvId) {
                loadData(currentBvId);
            }
        }

        // === Theme support ===
        function applyTheme(bgColor, opacity) {
            const hex = bgColor.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);

            const style = document.getElementById('dynamic-theme') || document.createElement('style');
            style.id = 'dynamic-theme';
            style.textContent = `
                .glass-panel { background: rgba(${r}, ${g}, ${b}, ${opacity * 0.6}) !important; }
                .drag-area { background-color: rgba(${r}, ${g}, ${b}, ${opacity * 0.8}) !important; }
                .stat-card:hover { background: rgba(${r}, ${g}, ${b}, ${opacity * 0.4}) !important; }
            `;
            if (!document.getElementById('dynamic-theme')) {
                document.head.appendChild(style);
            }
        }

        ipcRenderer.on('apply-ui-settings', (event, settings) => {
            applyTheme(settings.bgColor, settings.opacity);
        });

        async function loadThemeFromConfig() {
            try {
                const resp = await fetch('http://118.25.39.91:8000/api/config/');
                const result = await resp.json();
                if (result.success && result.data?.ui_config) {
                    applyTheme(result.data.ui_config.background_color, result.data.ui_config.opacity);
                }
            } catch (e) {
                console.error('Failed to load theme:', e);
            }
        }

        // 窗口大小变化时重绘图表
        window.addEventListener('resize', () => {
            pieChart?.resize();
            trendChart?.resize();
            hourlyChart?.resize();
            danmuHeatmapChart?.resize();
        });

        // === 登录状态同步 ===
        let isLoggedIn = false;

        // 监听登录状态同步
        ipcRenderer.on('sync-login-status', (event, status) => {
            isLoggedIn = status.loggedIn;
            console.log('登录状态同步:', isLoggedIn);
        });
    </script>
</body>
</html>
