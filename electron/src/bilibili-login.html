<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B站账号绑定 - BiliMood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .scan-line {
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 2px); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- 头部导航 -->
        <nav class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">
                <span class="text-pink-500">Bili</span>Mood
            </h1>
            <button @click="goBack" class="text-gray-400 hover:text-white transition">
                ← 返回首页
            </button>
        </nav>
        <!-- 主内容区 -->
        <div class="max-w-md mx-auto">
            <!-- 调试信息面板 -->
            <div class="mb-4 p-3 bg-gray-800/50 rounded-lg text-xs text-gray-400">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-white">调试信息</span>
                    <button @click="forceLogin" class="text-pink-500 hover:text-pink-400">
                        强制登录
                    </button>
                </div>
                <div>登录状态: <span :class="bilimoodLoggedIn ? 'text-green-400' : 'text-red-400'">
                    {{ bilimoodLoggedIn ? '✓ 已登录' : '✗ 未登录' }}
                </span></div>
                <div>用户名: {{ currentUser || '未设置' }}</div>
                <div>缓存: {{ localStorage.getItem('bilimood_user') ? '有' : '无' }}</div>
            </div>

            <!-- 未登录提示 -->
            <div v-if="!bilimoodLoggedIn" class="card-glass rounded-xl p-6 text-center">
                <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-white mb-2">请先登录</h2>
                <p class="text-gray-400 mb-6">请先登录 Bilimood 账号，再绑定 B站账号</p>
                <button @click="goToLogin"
                        class="bg-pink-600 hover:bg-pink-700 text-white py-2 px-6 rounded-lg transition">
                    去登录
                </button>
            </div>

            <!-- B站登录卡片 -->
            <div v-else class="card-glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <svg class="w-6 h-6 mr-2 text-pink-500" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.813 4h.027c.516 0 .743.378.747.75V7.3l-1.02-.468a1.233 1.233 0 00-1.265.275L13.5 9.563V5.25c0-.42.336-.75.75-.75h.016c.42 0 .75.337.75.75v7.688l1.812-1.856c.418-.426 1.2-.426 1.65 0l2.063 2.1c.213.213.33.5.33.806v1.518c0 .6-.48 1.1-1.08 1.1H8.55c-.6 0-1.08-.5-1.08-1.1v-3.9c0-.6.48-1.1 1.08-1.1h5.73c.6 0 1.08.5 1.08 1.1v2.85c0 .6-.48 1.1-1.08 1.1H6.51c-.6 0-1.08-.5-1.08-1.1V7.8c0-.6.48-1.1 1.08-1.1h2.28v-.75c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75V6.5l.6.277v3.98c0 .6-.48 1.1-1.08 1.1H6.51c-.6 0-1.08-.5-1.08-1.1V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v2.25h1.2V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v3h1.2V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v1.5l1.02-.468a1.233 1.233 0 00.675-1.032V4.5c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v.75h.75c.42 0 .75.337.75.75v1.5l1.02-.468a1.233 1.233 0 00.675-1.032V4.5c0-.42.336-.75.75-.75H17.813z"/>
                        </svg>
                        绑定 B站账号
                    </h2>
                    <span class="text-green-400 text-sm">{{ currentUser }}</span>
                </div>

                <!-- 登录成功状态 -->
                <div v-if="loginSuccess" class="text-center py-8">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">绑定成功!</h3>
                    <p class="text-gray-400 mb-4">用户ID: {{ loginResult.mid }}</p>
                    <button @click="goBack"
                            class="bg-pink-600 hover:bg-pink-700 text-white py-2 px-6 rounded-lg transition">
                        返回首页
                    </button>
                </div>

                <!-- 二维码状态 -->
                <div v-else-if="qrCode" class="text-center">
                    <div class="relative inline-block p-4 bg-white rounded-lg mb-4">
                        <img :src="qrCode" alt="登录二维码" class="w-48 h-48">
                        <div v-if="polling" class="scan-line absolute left-0 right-0 h-1 bg-pink-500"></div>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">{{ statusMessage }}</p>

                    <!-- 状态信息 -->
                    <div v-if="loginStatus.valid" class="mb-4 p-3 bg-green-500/20 rounded-lg">
                        <p class="text-green-400 text-sm">当前 SESSDATA 有效</p>
                    </div>

                    <!-- 错误信息 -->
                    <div v-if="errorMessage" class="p-3 bg-red-500/20 border border-red-500/50 rounded-lg mb-4">
                        <p class="text-red-400 text-sm">{{ errorMessage }}</p>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-2 justify-center">
                        <button @click="startPolling" :disabled="!authCode || polling"
                                class="bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 text-white py-2 px-4 rounded-lg transition">
                            {{ polling ? '扫描中...' : '刷新状态' }}
                        </button>
                        <button @click="generateQRCode"
                                class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition">
                            刷新二维码
                        </button>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div v-else-if="loading" class="flex justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                </div>

                <!-- 错误状态 -->
                <div v-else-if="errorMessage" class="text-center py-8">
                    <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </div>
                    <p class="text-red-400 mb-4">{{ errorMessage }}</p>
                    <button @click="generateQRCode"
                            class="bg-pink-600 hover:bg-pink-700 text-white py-2 px-6 rounded-lg transition">
                        重试
                    </button>
                </div>
            </div>

            <!-- 提示信息 -->
            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <h4 class="text-white font-medium mb-2">绑定说明</h4>
                <ul class="text-gray-400 text-sm space-y-1">
                    <li>1. 使用 B站 APP 扫描二维码</li>
                    <li>2. 确认登录后将自动绑定</li>
                    <li>3. 绑定成功后可用于爬取 B站数据</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 配置 axios 指向 Django 服务器
        axios.defaults.baseURL = 'http://118.25.39.91:8000';
        axios.defaults.withCredentials = true; // 携带 session cookie

        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            setup() {
                // 登录状态
                const bilimoodLoggedIn = ref(false);
                const currentUser = ref('');

                // B站登录状态
                const loading = ref(false);
                const qrCode = ref('');
                const authCode = ref('');
                const polling = ref(false);
                const loginSuccess = ref(false);
                const loginResult = ref({});
                const errorMessage = ref('');
                const statusMessage = ref('');
                const loginStatus = ref({ valid: false, message: '', needRefresh: false });

                // 从 localStorage 恢复登录状态
                const restoreLoginState = () => {
                    try {
                        const cached = localStorage.getItem('bilimood_user');
                        if (cached) {
                            const userData = JSON.parse(cached);
                            if (userData && userData.user_id) {
                                bilimoodLoggedIn.value = true;
                                currentUser.value = userData.username || '';
                                return true;
                            }
                        }
                    } catch (e) {
                        console.error('恢复登录状态失败:', e);
                    }
                    return false;
                };

                // 保存登录状态到 localStorage
                const saveLoginState = (username) => {
                    try {
                        localStorage.setItem('bilimood_user', JSON.stringify({
                            user_id: 1,
                            username: username,
                            loginTime: Date.now()
                        }));
                    } catch (e) {
                        console.error('保存登录状态失败:', e);
                    }
                };

                // 检查登录状态
                const checkStatus = async () => {
                    try {
                        console.log('开始检查登录状态...');
                        const res = await axios.get('/api/auth/check/');
                        console.log('登录检查响应:', res.data);

                        // 兼容多种响应格式
                        const isLoggedIn = res.data.logged_in || res.data.loggedIn || false;
                        const userData = res.data.data || res.data.user || null;

                        if (isLoggedIn && userData) {
                            const username = userData.username || '未知用户';
                            bilimoodLoggedIn.value = true;
                            currentUser.value = username;
                            // 保存到 localStorage
                            saveLoginState(username);
                            console.log('✅ 登录状态已确认:', username);
                            return true;
                        } else {
                            console.log('⚠️ API 返回未登录，尝试从缓存恢复');
                            // API 返回未登录，尝试从缓存恢复
                            return restoreLoginState();
                        }
                    } catch (e) {
                        // API 调用失败，尝试从缓存恢复
                        console.error('❌ API 调用失败:', e);
                        console.warn('尝试使用缓存恢复登录状态');
                        return restoreLoginState();
                    }
                };

                // 去登录页面
                const goToLogin = () => {
                    window.location.href = 'login.html';
                };

                // 生成二维码
                const generateQRCode = async () => {
                    loading.value = true;
                    errorMessage.value = '';
                    loginSuccess.value = false;
                    statusMessage.value = '加载中...';

                    try {
                        const res = await axios.get('/api/sessdata/qrcode/');

                        if (res.data.success) {
                            qrCode.value = res.data.data.qr_image;
                            authCode.value = res.data.data.auth_code;
                            statusMessage.value = '请使用B站APP扫描二维码';
                            startPolling();
                        } else if (res.data.need_bilimood_login) {
                            // 显示错误但不重置登录状态
                            errorMessage.value = '后端Session已失效: ' + (res.data.message || '请先登录');
                        } else {
                            errorMessage.value = res.data.message;
                        }
                    } catch (e) {
                        // 显示错误但不重置登录状态
                        if (e.response?.status === 401) {
                            errorMessage.value = '后端Session已失效(401): 需要真实的后端登录';
                        } else {
                            errorMessage.value = e.response?.data?.message || ('生成二维码失败: ' + e.message);
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                // 开始轮询
                const startPolling = () => {
                    if (!authCode.value) return;

                    polling.value = true;
                    pollLogin();
                };

                // 轮询登录状态
                const pollLogin = async () => {
                    if (!polling.value) return;

                    try {
                        const res = await axios.post('/api/sessdata/poll/', {
                            auth_code: authCode.value
                        });

                        if (res.data.success) {
                            loginSuccess.value = true;
                            polling.value = false;
                            loginResult.value = res.data.tokens;
                            statusMessage.value = '登录成功!';
                        } else if (res.data.status === 'waiting') {
                            statusMessage.value = '等待扫码...';
                            setTimeout(pollLogin, 2000);
                        } else if (res.data.status === 'confirmed') {
                            statusMessage.value = '已扫码，等待确认...';
                            setTimeout(pollLogin, 2000);
                        } else if (res.data.status === 'expired') {
                            errorMessage.value = '二维码已过期，请刷新';
                            polling.value = false;
                        } else if (res.data.need_bilimood_login) {
                            bilimoodLoggedIn.value = false;
                            polling.value = false;
                        } else {
                            errorMessage.value = res.data.message;
                            polling.value = false;
                        }
                    } catch (e) {
                        if (e.response?.status === 401) {
                            bilimoodLoggedIn.value = false;
                            errorMessage.value = '请先登录 Bilimood 账号';
                            polling.value = false;
                        } else if (e.response?.status === 400) {
                            errorMessage.value = e.response?.data?.message || '登录失败';
                            polling.value = false;
                        } else {
                            setTimeout(pollLogin, 2000);
                        }
                    }
                };

                // 返回首页
                const goBack = () => {
                    // 尝试关闭窗口
                    try {
                        if (window.electronAPI && window.electronAPI.closeWindow) {
                            window.electronAPI.closeWindow();
                            return;
                        }
                    } catch (e) {
                        console.log('Electron API 不可用:', e);
                    }

                    try {
                        window.close();
                        setTimeout(() => {
                            if (!window.closed) {
                                document.body.innerHTML = `
                                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
                                        <div style="text-align: center; color: white;">
                                            <h2 style="font-size: 24px; margin-bottom: 16px;">绑定完成</h2>
                                            <p style="color: #9ca3af; margin-bottom: 24px;">你可以关闭此标签页了</p>
                                            <button onclick="window.close()" style="background: #ec4899; color: white; padding: 8px 24px; border-radius: 8px; border: none; cursor: pointer;">
                                                关闭页面
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        }, 100);
                    } catch (e) {
                        console.error('关闭窗口失败:', e);
                    }
                };

                // 调试：检查登录状态和缓存
                const debugLogin = () => {
                    console.log('=== 调试信息 ===');
                    console.log('bilimoodLoggedIn:', bilimoodLoggedIn.value);
                    console.log('currentUser:', currentUser.value);
                    console.log('localStorage:', localStorage.getItem('bilimood_user'));

                    // 弹窗显示
                    alert(`登录状态: ${bilimoodLoggedIn.value ? '已登录' : '未登录'}\n用户: ${currentUser.value}\n\n缓存: ${localStorage.getItem('bilimood_user') || '无'}`);
                };

                // 强制登录（跳过检查）
                const forceLogin = () => {
                    bilimoodLoggedIn.value = true;
                    currentUser.value = 'defy';
                    saveLoginState('defy');
                    alert('已强制设置为登录状态，正在获取二维码...');
                    generateQRCode();
                };

                onMounted(async () => {
                    const loggedIn = await checkStatus();
                    console.log('检查登录状态结果:', loggedIn);
                    if (loggedIn) {
                        // 已登录，获取二维码
                        generateQRCode();
                    }
                    // 未登录时显示提示，不自动获取二维码
                });

                return {
                    // 登录状态
                    bilimoodLoggedIn,
                    currentUser,
                    goToLogin,
                    debugLogin,
                    forceLogin,
                    localStorage,

                    // B站登录
                    loading,
                    qrCode,
                    authCode,
                    polling,
                    loginSuccess,
                    loginResult,
                    errorMessage,
                    statusMessage,
                    loginStatus,
                    generateQRCode,
                    startPolling,
                    pollLogin,
                    goBack
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
