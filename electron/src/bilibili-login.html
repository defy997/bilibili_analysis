<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B站账号绑定 - BiliMood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .card-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .scan-line {
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 2px); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- 头部导航 -->
        <nav class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">
                <span class="text-pink-500">Bili</span>Mood
            </h1>
            <button @click="goBack" class="text-gray-400 hover:text-white transition">
                ← 返回首页
            </button>
        </nav>
        <!-- 主内容区 -->
        <div class="max-w-md mx-auto">
            <!-- Bilimood 登录表单 -->
            <div v-if="!bilimoodLoggedIn" class="card-glass rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-2 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    登录 Bilimood
                </h2>
                <p class="text-gray-400 text-sm mb-6">请先登录 Bilimood 账号，再绑定 B站</p>
                <form @submit.prevent="bilimoodLogin">
                    <div class="mb-4">
                        <label class="block text-gray-400 text-sm mb-2">用户名或邮箱</label>
                        <input v-model="loginForm.username" type="text"
                               class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-pink-500"
                               placeholder="请输入用户名或邮箱">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-400 text-sm mb-2">密码</label>
                        <input v-model="loginForm.password" type="password"
                               class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-pink-500"
                               placeholder="请输入密码">
                    </div>
                    <button type="submit" :disabled="loginLoading"
                            class="w-full bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 text-white py-2 px-4 rounded-lg transition">
                        {{ loginLoading ? '登录中...' : '登录' }}
                    </button>
                </form>
                <p v-if="loginError" class="mt-4 text-red-400 text-sm text-center">{{ loginError }}</p>
            </div>
            <!-- B站登录卡片 -->
            <div v-else class="card-glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <svg class="w-6 h-6 mr-2 text-pink-500" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.813 4h.027c.516 0 .743.378.747.75V7.3l-1.02-.468a1.233 1.233 0 00-1.265.275L13.5 9.563V5.25c0-.42.336-.75.75-.75h.016c.42 0 .75.337.75.75v7.688l1.812-1.856c.418-.426 1.2-.426 1.65 0l2.063 2.1c.213.213.33.5.33.806v1.518c0 .6-.48 1.1-1.08 1.1H8.55c-.6 0-1.08-.5-1.08-1.1v-3.9c0-.6.48-1.1 1.08-1.1h5.73c.6 0 1.08.5 1.08 1.1v2.85c0 .6-.48 1.1-1.08 1.1H6.51c-.6 0-1.08-.5-1.08-1.1V7.8c0-.6.48-1.1 1.08-1.1h2.28v-.75c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75V6.5l.6.277v3.98c0 .6-.48 1.1-1.08 1.1H6.51c-.6 0-1.08-.5-1.08-1.1V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v2.25h1.2V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v3h1.2V5.25c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v1.5l1.02-.468a1.233 1.233 0 00.675-1.032V4.5c0-.42.336-.75.75-.75h.027c.42 0 .75.337.75.75v.75h.75c.42 0 .75.337.75.75v1.5l1.02-.468a1.233 1.233 0 00.675-1.032V4.5c0-.42.336-.75.75-.75H17.813z"/>
                        </svg>
                        绑定 B站账号
                    </h2>
                    <span class="text-green-400 text-sm">{{ currentUser }}</span>
                </div>

                <!-- 登录成功状态 -->
                <div v-if="loginSuccess" class="text-center py-8">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">绑定成功!</h3>
                    <p class="text-gray-400 mb-4">用户ID: {{ loginResult.mid }}</p>
                    <button @click="goBack"
                            class="bg-pink-600 hover:bg-pink-700 text-white py-2 px-6 rounded-lg transition">
                        返回首页
                    </button>
                </div>

                <!-- 二维码状态 -->
                <div v-else-if="qrCode" class="text-center">
                    <div class="relative inline-block p-4 bg-white rounded-lg mb-4">
                        <img :src="qrCode" alt="登录二维码" class="w-48 h-48">
                        <div v-if="polling" class="scan-line absolute left-0 right-0 h-1 bg-pink-500"></div>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">{{ statusMessage }}</p>

                    <!-- 状态信息 -->
                    <div v-if="loginStatus.valid" class="mb-4 p-3 bg-green-500/20 rounded-lg">
                        <p class="text-green-400 text-sm">当前 SESSDATA 有效</p>
                    </div>

                    <!-- 错误信息 -->
                    <div v-if="errorMessage" class="p-3 bg-red-500/20 border border-red-500/50 rounded-lg mb-4">
                        <p class="text-red-400 text-sm">{{ errorMessage }}</p>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-2 justify-center">
                        <button @click="startPolling" :disabled="!authCode || polling"
                                class="bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 text-white py-2 px-4 rounded-lg transition">
                            {{ polling ? '扫描中...' : '刷新状态' }}
                        </button>
                        <button @click="generateQRCode"
                                class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition">
                            刷新二维码
                        </button>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div v-else-if="loading" class="flex justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                </div>
            </div>

            <!-- 提示信息 -->
            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <h4 class="text-white font-medium mb-2">绑定说明</h4>
                <ul class="text-gray-400 text-sm space-y-1">
                    <li>1. 请先登录 Bilimood 账号</li>
                    <li>2. 使用 B站 APP 扫描二维码</li>
                    <li>3. 确认登录后将自动绑定</li>
                    <li>4. 绑定成功后可用于爬取 B站数据</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 配置 axios 指向 Django 服务器
        axios.defaults.baseURL = 'http://127.0.0.1:8000';

        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            setup() {
                // Bilimood 登录状态
                const bilimoodLoggedIn = ref(false);
                const loginForm = ref({ username: '', password: '' });
                const loginLoading = ref(false);
                const loginError = ref('');
                const currentUser = ref('');

                // B站登录状态
                const loading = ref(false);
                const qrCode = ref('');
                const authCode = ref('');
                const polling = ref(false);
                const loginSuccess = ref(false);
                const loginResult = ref({});
                const errorMessage = ref('');
                const statusMessage = ref('请使用B站APP扫描二维码');
                const loginStatus = ref({ valid: false, message: '', needRefresh: false });

                // Bilimood 登录
                const bilimoodLogin = async () => {
                    if (!loginForm.value.username || !loginForm.value.password) {
                        loginError.value = '请填写用户名和密码';
                        return;
                    }

                    loginLoading.value = true;
                    loginError.value = '';

                    try {
                        const res = await axios.post('/api/auth/login/', {
                            username: loginForm.value.username,
                            password: loginForm.value.password
                        });

                        if (res.data.success) {
                            bilimoodLoggedIn.value = true;
                            currentUser.value = res.data.data.username;
                            // 登录成功后自动生成 B站 二维码
                            await generateQRCode();
                        } else {
                            loginError.value = res.data.message;
                        }
                    } catch (e) {
                        loginError.value = e.response?.data?.message || '登录失败';
                    } finally {
                        loginLoading.value = false;
                    }
                };

                // 检查登录状态
                const checkStatus = async () => {
                    try {
                        const res = await axios.get('/api/auth/check/');
                        if (res.data.logged_in) {
                            bilimoodLoggedIn.value = true;
                            currentUser.value = res.data.data.username;
                            return true;
                        } else {
                            bilimoodLoggedIn.value = false;
                            return false;
                        }
                    } catch (e) {
                        bilimoodLoggedIn.value = false;
                        return false;
                    }
                };

                // 生成二维码
                const generateQRCode = async () => {
                    loading.value = true;
                    errorMessage.value = '';
                    loginSuccess.value = false;

                    try {
                        const res = await axios.get('/api/sessdata/qrcode/');

                        if (res.data.success) {
                            qrCode.value = res.data.data.qr_image;
                            authCode.value = res.data.data.auth_code;
                            statusMessage.value = '请使用B站APP扫描二维码';
                            startPolling();
                        } else if (res.data.need_bilimood_login) {
                            // 需要先登录 Bilimood
                            bilimoodLoggedIn.value = false;
                            loginError.value = '请先登录 Bilimood 账号';
                        } else {
                            errorMessage.value = res.data.message;
                        }
                    } catch (e) {
                        if (e.response?.status === 401) {
                            bilimoodLoggedIn.value = false;
                            loginError.value = '请先登录 Bilimood 账号';
                        } else {
                            errorMessage.value = e.response?.data?.message || '生成二维码失败';
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                // 开始轮询
                const startPolling = () => {
                    if (!authCode.value) return;

                    polling.value = true;
                    pollLogin();
                };

                // 轮询登录状态
                const pollLogin = async () => {
                    if (!polling.value) return;

                    try {
                        const res = await axios.post('/api/sessdata/poll/', {
                            auth_code: authCode.value
                        });

                        if (res.data.success) {
                            loginSuccess.value = true;
                            polling.value = false;
                            loginResult.value = res.data.tokens;
                            statusMessage.value = '登录成功!';
                        } else if (res.data.status === 'waiting') {
                            statusMessage.value = '等待扫码...';
                            setTimeout(pollLogin, 2000);
                        } else if (res.data.status === 'confirmed') {
                            statusMessage.value = '已扫码，等待确认...';
                            setTimeout(pollLogin, 2000);
                        } else if (res.data.status === 'expired') {
                            errorMessage.value = '二维码已过期，请刷新';
                            polling.value = false;
                        } else if (res.data.need_bilimood_login) {
                            bilimoodLoggedIn.value = false;
                            loginError.value = '请先登录 Bilimood 账号';
                            polling.value = false;
                        } else {
                            errorMessage.value = res.data.message;
                            polling.value = false;
                        }
                    } catch (e) {
                        if (e.response?.status === 401) {
                            bilimoodLoggedIn.value = false;
                            loginError.value = '请先登录 Bilimood 账号';
                            polling.value = false;
                        } else if (e.response?.status === 400) {
                            errorMessage.value = e.response?.data?.message || '登录失败';
                            polling.value = false;
                        } else {
                            setTimeout(pollLogin, 2000);
                        }
                    }
                };

                // 返回首页 - 关闭当前窗口
                const goBack = () => {
                    // 尝试关闭窗口
                    try {
                        // 方式1: 如果是 Electron，使用 IPC 通信关闭窗口
                        if (window.electronAPI && window.electronAPI.closeWindow) {
                            window.electronAPI.closeWindow();
                            return;
                        }
                    } catch (e) {
                        console.log('Electron API 不可用:', e);
                    }

                    // 方式2: 使用 window.close() 关闭窗口
                    try {
                        window.close();

                        // 如果 window.close() 没有效果（浏览器安全限制），
                        // 延迟检查窗口是否已关闭
                        setTimeout(() => {
                            // 如果窗口还在，说明无法关闭，则清空页面内容
                            if (!window.closed) {
                                console.log('无法关闭窗口，清空页面内容');
                                document.body.innerHTML = `
                                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);">
                                        <div style="text-align: center; color: white;">
                                            <h2 style="font-size: 24px; margin-bottom: 16px;">绑定完成</h2>
                                            <p style="color: #9ca3af; margin-bottom: 24px;">你可以关闭此标签页了</p>
                                            <button onclick="window.close()" style="background: #ec4899; color: white; padding: 8px 24px; border-radius: 8px; border: none; cursor: pointer;">
                                                关闭页面
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        }, 100);
                    } catch (e) {
                        console.error('关闭窗口失败:', e);
                    }
                };

                onMounted(async () => {
                    await checkStatus();
                });

                return {
                    // Bilimood 登录
                    bilimoodLoggedIn,
                    loginForm,
                    loginLoading,
                    loginError,
                    currentUser,
                    bilimoodLogin,

                    // B站登录
                    loading,
                    qrCode,
                    authCode,
                    polling,
                    loginSuccess,
                    loginResult,
                    errorMessage,
                    statusMessage,
                    loginStatus,
                    generateQRCode,
                    startPolling,
                    pollLogin,
                    goBack
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
