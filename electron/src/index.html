<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiliMood Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent; 
        }

        /* 核心毛玻璃效果 */
        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* 拖拽区域样式 */
        .drag-area {
            -webkit-app-region: drag;
            cursor: grab;
        }
        .drag-area:active {
            cursor: grabbing;
        }

        /* 防止按钮被拖拽 */
        .no-drag {
            -webkit-app-region: no-drag;
        }

        /* 卡片交互样式 */
        .nav-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: transparent;
        }
        .nav-card:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .nav-card.active {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        /* 内切圆遮罩 - 只负责切割形状 */
        .mask-tr-2 {
            -webkit-mask: radial-gradient(circle 150px at calc(100% + 2px) -2px, #0000 98%, #000);
            mask: radial-gradient(circle 150px at calc(100% + 2px) -2px, #0000 98%, #000);
        }
        .mask-tl-2 {
            -webkit-mask: radial-gradient(circle 150px at -2px -2px, #0000 98%, #000);
            mask: radial-gradient(circle 150px at -2px -2px, #0000 98%, #000);
        }
        .mask-br-2 {
            -webkit-mask: radial-gradient(circle 150px at calc(100% + 2px) calc(100% + 2px), #0000 98%, #000);
            mask: radial-gradient(circle 150px at calc(100% + 2px) calc(100% + 2px), #0000 98%, #000);
        }
        .mask-bl-2 {
            -webkit-mask: radial-gradient(circle 150px at -2px calc(100% + 2px), #0000 98%, #000);
            mask: radial-gradient(circle 150px at -2px calc(100% + 2px), #0000 98%, #000);
        }

        /* 使用伪元素绘制内切圆弧的白色边框 */
        .mask-tr-2::before {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 154px;
            height: 154px;
            background: radial-gradient(circle 150px at calc(100% + 2px) -2px, transparent 148px, rgba(255, 255, 255, 0.4) 148px, rgba(255, 255, 255, 0.4) 150px, transparent 150px);
            pointer-events: none;
        }
        .mask-tl-2::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            width: 154px;
            height: 154px;
            background: radial-gradient(circle 150px at -2px -2px, transparent 148px, rgba(255, 255, 255, 0.4) 148px, rgba(255, 255, 255, 0.4) 150px, transparent 150px);
            pointer-events: none;
        }
        .mask-br-2::before {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 154px;
            height: 154px;
            background: radial-gradient(circle 150px at calc(100% + 2px) calc(100% + 2px), transparent 148px, rgba(255, 255, 255, 0.4) 148px, rgba(255, 255, 255, 0.4) 150px, transparent 150px);
            pointer-events: none;
        }
        .mask-bl-2::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -2px;
            width: 154px;
            height: 154px;
            background: radial-gradient(circle 150px at -2px calc(100% + 2px), transparent 148px, rgba(255, 255, 255, 0.4) 148px, rgba(255, 255, 255, 0.4) 150px, transparent 150px);
            pointer-events: none;
        }

        /* 优化内切后的边框显示，防止边框在切口处显得太生硬 */
        .nav-card {
            -webkit-mask-composite: source-in;
            mask-composite: intersect;
        }
            /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(236, 72, 153, 0.5); /* pink-500 */
        }

        /* 简单的进入动画 */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-in {
            animation: zoomIn 0.2s ease-out forwards;
        }

        /* Toast 提示样式 */
        #toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            text-align: center;
        }
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* 未登录遮罩层 */
        #login-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #login-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .lock-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .lock-icon i {
            font-size: 28px;
            color: white;
        }
        #login-overlay h3 {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }
        #login-overlay p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
        }
        #login-overlay button {
            padding: 12px 32px;
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #login-overlay button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
        }
    </style>
</head>
<body class="h-screen flex flex-col text-white overflow-hidden">

    <!-- 悬浮窗主体容器 -->
    <div id="main-container" class="w-full h-full flex flex-col relative">

        <!-- Toast 提示容器 -->
        <div id="toast-container"></div>

        <!-- 未登录遮罩层 -->
        <div id="login-overlay" class="hidden">
            <div class="lock-icon">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h3>Login Required</h3>
            <p>Please login to access all features</p>
            <button onclick="toggleLogin(true)">Login / Register</button>
        </div>
        
        <!-- 顶部导航栏 -->
        <div class="h-12 w-full drag-area flex justify-between items-center px-4 select-none z-20 border-b border-white/10 bg-white/5 flex-shrink-0">
            <!-- 左侧：应用标识 -->
            <div class="flex items-center gap-2 opacity-90">
                <i class="fa-brands fa-bilibili text-pink-500 text-lg"></i>
                <span class="font-bold text-sm tracking-wider">BiliMood</span>
            </div>
            
            <!-- 右侧：功能导航 -->
            <div class="flex items-center gap-4 no-drag text-xs font-medium">
                <!-- 未登录时显示登录按钮 -->
                <button id="login-btn" onclick="toggleLogin(true)" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-user"></i>
                    <span>Login</span>
                </button>
                <!-- 已登录时显示用户名和登出 -->
                <div id="user-info" class="hidden flex items-center gap-3">
                    <span id="display-username" class="text-pink-400"></span>
                    <button onclick="handleLogout()" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                        <i class="fa-solid fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
                <button onclick="toggleSettings(true)" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                    <i class="fa-solid fa-gear"></i>
                    <span>Settings</span>
                </button>
            </div>
        </div>

        <!-- 中间内容区域：2x2 网格布局 -->
        <!-- flex-1 占据剩余空间 -->
        <div class="flex-1 w-full p-4 grid grid-cols-2 grid-rows-2 gap-0 overflow-hidden">
            
            <!-- 卡片 1: User Profile (切右下角) -->
            <div onclick="toggleCard('user', this)" class="nav-card relative rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl mask-br-2 border-2 border-white/40 p-4 flex flex-col items-center justify-center text-center group">
                <span class="text-lg font-bold tracking-wide">User Analysis</span>
                <span class="text-xs text-white/40 mt-2">Manage your account</span>
                <div class="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center mb-4 text-blue-400 group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-user text-2xl"></i>
                </div>
            </div>

            <!-- 卡片 2: Emotional Analysis (切左下角) -->
            <div onclick="toggleCard('emotional', this)" class="nav-card relative rounded-tl-3xl rounded-br-3xl rounded-tr-3xl mask-bl-2 border-2 border-white/40 p-4 flex flex-col items-center justify-center text-center group">
                <span class="text-lg font-bold tracking-wide">Emotional Analysis</span>
                <span class="text-xs text-white/40 mt-2">Sentiment trends</span>
                <div class="w-16 h-16 rounded-full bg-pink-500/20 flex items-center justify-center mb-4 text-pink-400 group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-heart-crack text-2xl"></i>
                </div>
            </div>

            <!-- 卡片 3: Video Analysis (切右上角) -->
            <div onclick="toggleCard('video', this)" class="nav-card relative rounded-br-3xl rounded-tl-3xl rounded-bl-3xl mask-tr-2 border-2 border-white/40 p-4 flex flex-col items-center justify-center text-center group">
                <div class="w-16 h-16 rounded-full bg-purple-500/20 flex items-center justify-center mb-4 text-purple-400 group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-video text-2xl"></i>
                </div>
                <span class="text-lg font-bold tracking-wide">Video Analysis</span>
                <span class="text-xs text-white/40 mt-2">Video insights</span>
            </div>

            <!-- 卡片 4: Comparative Analysis (切左上角) -->
            <div onclick="toggleCard('compare', this)" class="nav-card relative rounded-bl-3xl rounded-tr-3xl rounded-br-3xl mask-tl-2 border-2 border-white/40 p-4 flex flex-col items-center justify-center text-center group">
                <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center mb-4 text-yellow-400 group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-chart-simple text-2xl"></i>
                </div>
                <span class="text-lg font-bold tracking-wide">Comparative Analysis</span>
                <span class="text-xs text-white/40 mt-2">Compare results</span>
            </div>

        </div>

        <!-- 底部导航栏 -->
        <div class="h-12 w-full flex justify-around items-center border-t border-white/10 bg-white/5 flex-shrink-0 no-drag text-[13px] font-medium">
            <button onclick="expandWindow()" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                <i class="fa-solid fa-expand"></i>
                <span>Expand</span>
            </button>
            <button onclick="login()" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                <i class="fa-solid fa-user"></i>
                <span>Login</span>
            </button>
            <button onclick="settings()" class="hover:text-pink-400 transition-colors flex items-center gap-1">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </button>
        </div>

        <!-- 设置面板覆盖层 -->
        <div id="settingsPanel" class="absolute inset-0 z-50 items-center justify-center p-4 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="toggleSettings(false)"></div>
            
            <div class="glass-panel w-full max-w-[320px] h-[85%] rounded-[2rem] border border-white/20 flex flex-col overflow-hidden relative z-10 shadow-2xl animate-in zoom-in-95 duration-200">
                
                <div class="p-5 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <h3 class="text-sm font-black uppercase tracking-[0.2em] text-pink-500">Preference</h3>
                    <button onclick="toggleSettings(false)" class="no-drag hover:rotate-90 transition-transform duration-300" title="Close settings" aria-label="Close settings">
                        <i class="fa-solid fa-xmark text-white/40 hover:text-white"></i>
                    </button>
                </div>
        
                <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">

                    <!-- 白名单配置 -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-white/30 uppercase tracking-widest">Whitelist (保留热门评论)</label>

                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10 space-y-3">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">高赞阈值</span>
                                    <span id="high-like-value" class="text-[11px] text-pink-400">50</span>
                                </div>
                                <input type="range" id="high-like" min="10" max="200" value="50"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('high-like-value').innerText = this.value"
                                       aria-label="高赞阈值">
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">热门讨论阈值</span>
                                    <span id="high-reply-value" class="text-[11px] text-pink-400">10</span>
                                </div>
                                <input type="range" id="high-reply" min="3" max="50" value="10"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('high-reply-value').innerText = this.value"
                                       aria-label="热门讨论阈值">
                            </div>
                        </div>
                    </div>

                    <!-- 过滤配置 -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-white/30 uppercase tracking-widest">Filter (过滤设置)</label>

                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10 space-y-3">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">最小中文占比</span>
                                    <span id="chinese-ratio-value" class="text-[11px] text-pink-400">15%</span>
                                </div>
                                <input type="range" id="chinese-ratio" min="0" max="50" value="15"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('chinese-ratio-value').innerText = this.value + '%'"
                                       aria-label="最小中文占比">
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">最小质量评分</span>
                                    <span id="quality-score-value" class="text-[11px] text-pink-400">0.20</span>
                                </div>
                                <input type="range" id="quality-score" min="0" max="50" value="20"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('quality-score-value').innerText = (this.value/100).toFixed(2)"
                                       aria-label="最小质量评分">
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">最大重复字符</span>
                                    <span id="char-repeat-value" class="text-[11px] text-pink-400">10</span>
                                </div>
                                <input type="range" id="char-repeat" min="5" max="30" value="10"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('char-repeat-value').innerText = this.value"
                                       aria-label="最大重复字符">
                            </div>
                        </div>
                    </div>

                    <!-- 去重配置 -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-white/30 uppercase tracking-widest">Deduplication</label>
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-white/80">去重方法</span>
                            </div>
                            <select id="dedup-method" class="w-full bg-black/20 border-none text-[11px] rounded-lg py-2 focus:outline-none appearance-none cursor-pointer text-white/80" aria-label="去重方法">
                                <option value="exact">精确去重 (推荐)</option>
                                <option value="fuzzy">模糊去重</option>
                                <option value="embedding">语义去重 (慢)</option>
                                <option value="all">全部去重 (最慢)</option>
                            </select>
                        </div>
                    </div>

                    <!-- UI配置 -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-white/30 uppercase tracking-widest">Appearance (外观)</label>

                        <div class="bg-white/5 p-3 rounded-2xl border border-white/10 space-y-3">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">背景颜色</span>
                                    <span id="bg-color-value" class="text-[11px] text-pink-400">#1a1a2e</span>
                                </div>
                                <input type="color" id="bg-color" value="#1a1a2e"
                                       class="w-full h-10 bg-transparent border border-white/10 rounded-lg cursor-pointer"
                                       oninput="document.getElementById('bg-color-value').innerText = this.value; applyUISettings()"
                                       aria-label="背景颜色">
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[11px] text-white/60">透明度</span>
                                    <span id="opacity-value" class="text-[11px] text-pink-400">95%</span>
                                </div>
                                <input type="range" id="opacity" min="50" max="100" value="95"
                                       class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-pink-500"
                                       oninput="document.getElementById('opacity-value').innerText = this.value + '%'; applyUISettings()"
                                       aria-label="透明度">
                            </div>
                        </div>
                    </div>

                    <div class="pt-2">
                        <div class="bg-gradient-to-br from-pink-500/10 to-purple-500/10 p-4 rounded-2xl border border-pink-500/10">
                            <p class="text-[10px] text-white/40 leading-relaxed text-center">
                                BiliMood v1.2.0<br>
                                数据过滤引擎 v2.0
                            </p>
                        </div>
                    </div>
                </div>

                <div class="p-5">
                    <button onclick="saveSettings()" class="w-full bg-white text-black text-xs font-bold py-3 rounded-2xl hover:bg-pink-500 hover:text-white transition-all duration-300 active:scale-95 shadow-lg shadow-white/5">
                        APPLY CHANGES
                    </button>
                </div>
            </div>
        </div>
        <div id="loginPanel" class="absolute inset-0 z-50 items-center justify-center p-4 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="toggleLogin(false)"></div>
            
            <div class="glass-panel w-full max-w-[380px] rounded-[2.5rem] border border-white/20 flex flex-col overflow-hidden relative z-10 shadow-2xl animate-in zoom-in-95 duration-300 p-8">
                
                <!-- Logo -->
                <div class="flex justify-center mb-6">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center shadow-lg shadow-pink-500/30">
                        <i class="fa-brands fa-bilibili text-4xl text-white"></i>
                    </div>
                </div>
                
                <!-- Title -->
                <h2 class="text-2xl font-bold text-white text-center mb-8 tracking-wide">BiliMood</h2>
                
                <!-- Inputs -->
                <div class="space-y-4">
                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Account</label>
                        <input id="login-account" type="text" placeholder="Username or Email"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Password</label>
                        <input id="login-password" type="password" placeholder="Password"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>
                </div>

                <!-- Login Button -->
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3.5 rounded-2xl mt-8 hover:shadow-lg hover:shadow-pink-500/30 hover:scale-[1.02] active:scale-95 transition-all duration-300">
                    Login
                </button>
                
                <!-- Footer Links -->
                <div class="flex justify-center gap-4 mt-6">
                    <a href="#" class="text-xs text-white/40 hover:text-pink-400 transition-colors">Forgot Password?</a>
                    <span class="text-white/20">|</span>
                    <a href="#" onclick="switchToRegister(); return false;" class="text-xs text-pink-400 hover:text-pink-300 transition-colors">Register</a>
                </div>
            </div>
        </div>

        <!-- Register Panel -->
        <div id="registerPanel" class="absolute inset-0 z-50 items-center justify-center p-4 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="toggleRegister(false)"></div>
            
            <div class="glass-panel w-full max-w-[380px] rounded-[2.5rem] border border-white/20 flex flex-col overflow-hidden relative z-10 shadow-2xl animate-in zoom-in-95 duration-300 p-8">
                
                <!-- Logo -->
                <div class="flex justify-center mb-6">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center shadow-lg shadow-pink-500/30">
                        <i class="fa-brands fa-bilibili text-4xl text-white"></i>
                    </div>
                </div>
                
                <!-- Title -->
                <h2 class="text-2xl font-bold text-white text-center mb-8 tracking-wide">Create Account</h2>
                
                <!-- Inputs -->
                <div class="space-y-4">
                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Username</label>
                        <input id="register-username" type="text" placeholder="Choose a username"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Email</label>
                        <input id="register-email" type="email" placeholder="your@email.com"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Verification Code</label>
                        <div class="flex gap-2">
                            <input id="register-code" type="text" placeholder="Enter code" maxlength="6"
                                   class="flex-1 bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                            <button id="send-code-btn" onclick="sendVerificationCode()" type="button"
                                    class="px-4 py-3 bg-white/10 border border-white/10 rounded-2xl text-xs text-white hover:bg-white/20 transition-all whitespace-nowrap">
                                Send Code
                            </button>
                        </div>
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Password (8+ chars with letters)</label>
                        <input id="register-password" type="password" placeholder="Create a password"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>

                    <div class="space-y-1.5">
                        <label class="text-[11px] text-white/50 uppercase tracking-wider ml-1">Confirm Password</label>
                        <input id="register-confirm-password" type="password" placeholder="Confirm your password"
                               class="w-full bg-white/10 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder:text-white/30 focus:outline-none focus:border-pink-500/50 focus:bg-white/15 transition-all">
                    </div>
                </div>

                <!-- Register Button -->
                <button onclick="handleRegister()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3.5 rounded-2xl mt-8 hover:shadow-lg hover:shadow-pink-500/30 hover:scale-[1.02] active:scale-95 transition-all duration-300">
                    Register
                </button>
                
                <!-- Footer Links -->
                <div class="flex justify-center gap-4 mt-6">
                    <span class="text-xs text-white/40">Already have an account?</span>
                    <a href="#" onclick="switchToLogin(); return false;" class="text-xs text-pink-400 hover:text-pink-300 transition-colors">Login</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // === 全局登录状态 ===
        let isLoggedIn = false;
        let currentUser = null;

        // === Toast 提示函数 ===
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            // 自动移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // === 窗口控制 ===
        function minimizeWindow() {
            ipcRenderer.send('minimize-window');
        }
        function toggleMinimize() {
            ipcRenderer.send('minimize-window');
        }
        function closeWindow() {
            ipcRenderer.send('close-window');
        }
        window.addEventListener('beforeunload', (e) => {
            e.returnValue = false;
        });

        // 更新登录状态
        function updateLoginUI() {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const displayUsername = document.getElementById('display-username');

            if (isLoggedIn && currentUser) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                displayUsername.textContent = currentUser.username;
                // 广播登录状态到所有子窗口
                ipcRenderer.send('broadcast-login-status', { loggedIn: true, user: currentUser });
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                // 广播登出状态到所有子窗口
                ipcRenderer.send('broadcast-login-status', { loggedIn: false });
            }
        }

        function updateLoginOverlay() {
            const overlay = document.getElementById('login-overlay');
            if (!isLoggedIn) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('visible'), 10);
            } else {
                overlay.classList.remove('visible');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // 检查登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/check/`);
                const result = await response.json();
                if (result.success && result.logged_in) {
                    isLoggedIn = true;
                    currentUser = result.data;
                    updateLoginUI();
                    updateLoginOverlay();
                } else {
                    isLoggedIn = false;
                    currentUser = null;
                    updateLoginUI();
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
            }
        }

        // === 卡片开关逻辑（需要登录） ===
        function toggleCard(moduleName, element) {
            // 检查是否登录
            if (!isLoggedIn) {
                showToast('Please login first', 'warning');
                toggleLogin(true);
                return;
            }

            // 切换当前卡片的active状态
            const isActive = element.classList.contains('active');

            if (isActive) {
                // 如果已激活，则关闭模块
                element.classList.remove('active');
                if (moduleName === 'emotional') {
                    ipcRenderer.send('close-analysis-window');
                }
                if (moduleName === 'user') {
                    ipcRenderer.send('close-user-profile-window');
                }
                if (moduleName === 'video') {
                    ipcRenderer.send('close-video-audio-window');
                }
            } else {
                // 如果未激活，则开启模块
                element.classList.add('active');

                if (moduleName === 'emotional') {
                    ipcRenderer.send('toggle-analysis-window');
                }
                if (moduleName === 'user') {
                    ipcRenderer.send('toggle-user-profile-window');
                }
                if (moduleName === 'video') {
                    ipcRenderer.send('toggle-video-audio-window');
                }
            }
        }

        function settings(){
            if (!isLoggedIn) {
                showToast('Please login first', 'warning');
                toggleLogin(true);
                return;
            }
            toggleSettings(true);
        }
        function toggleSettings(show) {
            const panel = document.getElementById('settingsPanel');
             if (show) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
                panel.classList.add('animate-in', 'fade-in', 'zoom-in', 'duration-300');
            } else {
                panel.classList.remove('flex');
                panel.classList.add('hidden');
            }
        }
        function login(){
            toggleLogin(true);
        }
        function toggleLogin(show){
            const panel = document.getElementById("loginPanel");
            if(show){
                panel.classList.remove('hidden');
                panel.classList.add('flex');
                panel.classList.add('animate-in','fade-in','zoom-in','duration-300');
            }else{
                panel.classList.remove('flex');
                panel.classList.add('hidden');
            }
        }

        function toggleRegister(show){
            const panel = document.getElementById("registerPanel");
            if(show){
                panel.classList.remove('hidden');
                panel.classList.add('flex');
                panel.classList.add('animate-in','fade-in','zoom-in','duration-300');
            }else{
                panel.classList.remove('flex');
                panel.classList.add('hidden');
            }
        }
        
        // === 切换登录/注册面板 ===
        function switchToRegister() {
            toggleLogin(false);
            setTimeout(() => toggleRegister(true), 200);
        }
        
        function switchToLogin() {
            toggleRegister(false);
            setTimeout(() => toggleLogin(true), 200);
        }
        

        // === 打开独立模块窗口 ===
        function openModule(moduleName) {
            ipcRenderer.send('toggle-analysis-window');
        }

        // === 关闭模块 ===
        function closeModule() {
            ipcRenderer.send('close-analysis-window');
        }

        function expandWindow() {
            // 展开功能
            showToast('Expand feature coming soon', 'info');
        }
        // === API 基础配置 ===
        const API_BASE = 'http://118.25.39.91:8000';
        
        // === 通用 API 调用函数 ===
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                if (error.message.includes('getaddrinfo')) {
                    throw new Error('无法连接到后端服务器，请确保 Django 服务已启动\n端口: 8000');
                }
                throw error;
            }
        }
        
        // === 加载配置 ===
        async function loadConfig() {
            try {
                const result = await apiCall('/api/config/');

                if (result.success && result.data) {
                    applyUserConfig(result.data);
                }
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }

        // === 应用UI设置 ===
        function applyUISettings() {
            const bgColor = document.getElementById('bg-color').value;
            const opacity = parseInt(document.getElementById('opacity').value) / 100;

            // 将16进制颜色转换为RGB
            const hex = bgColor.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);

            console.log(`应用UI设置: 颜色=${bgColor}, 透明度=${opacity}`);

            // 应用到主容器（而不是body，避免与Electron透明窗口冲突）
            const mainContainer = document.getElementById('main-container');
            if (mainContainer) {
                mainContainer.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }

            // 更新动态样式（导航栏和卡片）
            const style = document.getElementById('dynamic-styles') || document.createElement('style');
            style.id = 'dynamic-styles';
            style.textContent = `
                /* 主容器 - 禁用背景色过渡 */
                #main-container {
                    transition: none !important;
                }

                /* 顶部导航栏 */
                .drag-area {
                    background-color: rgba(${r}, ${g}, ${b}, ${opacity * 0.8}) !important;
                    transition: none !important;
                }

                /* 底部导航栏 */
                .border-t.border-white\\/10 {
                    background-color: rgba(${r}, ${g}, ${b}, ${opacity * 0.8}) !important;
                    transition: none !important;
                }

                /* 卡片基础样式 - 只保留 transform 和 border 的过渡 */
                .nav-card {
                    background-color: rgba(${r}, ${g}, ${b}, ${opacity * 0.3}) !important;
                    transition: transform 0.3s ease, border-color 0.3s ease !important;
                }

                /* 卡片悬停效果 */
                .nav-card:hover {
                    background-color: rgba(${r}, ${g}, ${b}, ${opacity * 0.5}) !important;
                }

                /* 卡片激活状态 */
                .nav-card.active {
                    background-color: rgba(236, 72, 153, ${opacity * 0.3}) !important;
                }
            `;
            if (!document.getElementById('dynamic-styles')) {
                document.head.appendChild(style);
            }

            // 广播设置到所有子窗口
            ipcRenderer.send('broadcast-ui-settings', { bgColor, opacity });
        }

        // === 保存配置 ===
        async function saveSettings() {
            try {
                const config = {
                    filter_config: {
                        min_chinese_ratio: parseInt(document.getElementById('chinese-ratio').value) / 100,
                        min_quality_score: parseInt(document.getElementById('quality-score').value) / 100,
                        max_char_repeat: parseInt(document.getElementById('char-repeat').value),
                        dedup_method: document.getElementById('dedup-method').value
                    },
                    whitelist_config: {
                        high_like_threshold: parseInt(document.getElementById('high-like').value),
                        high_reply_threshold: parseInt(document.getElementById('high-reply').value),
                        combined_like_threshold: 20,  // 保持默认
                        combined_reply_threshold: 5   // 保持默认
                    },
                    ui_config: {
                        background_color: document.getElementById('bg-color').value,
                        opacity: parseInt(document.getElementById('opacity').value) / 100
                    }
                };

                const response = await fetch('http://118.25.39.91:8000/api/config/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    // 应用UI设置
                    applyUISettings();
                    // 显示成功提示
                    alert('配置保存成功！');
                    toggleSettings(false);
                } else {
                    alert('保存失败: ' + result.error);
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                alert('保存失败: ' + error.message);
            }
        }

        // 监听分析窗口关闭事件
        ipcRenderer.on('analysis-window-closed', () => {
            const cards = document.querySelectorAll('.nav-card');
            cards.forEach(card => {
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes("'emotional'")) {
                    card.classList.remove('active');
                }
            });
        });

        // 监听视频音频分析窗口关闭事件
        ipcRenderer.on('video-audio-window-closed', () => {
            const cards = document.querySelectorAll('.nav-card');
            cards.forEach(card => {
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes("'video'")) {
                    card.classList.remove('active');
                }
            });
        });

        // 监听用户画像窗口关闭事件
        ipcRenderer.on('user-profile-window-closed', () => {
            const cards = document.querySelectorAll('.nav-card');
            cards.forEach(card => {
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes("'user'")) {
                    card.classList.remove('active');
                }
            });
        });

        // === 用户认证功能 ===
        let sendCodeCountdown = 0;

        // 发送验证码
        async function sendVerificationCode() {
            const email = document.getElementById('register-email').value.trim();

            if (!email) {
                showToast('Please enter your email', 'warning');
                return;
            }

            if (sendCodeCountdown > 0) {
                return;
            }

            const btn = document.getElementById('send-code-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/send-code/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, purpose: 'register' })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Verification code sent!', 'success');
                    // 开发模式显示验证码
                    if (result.code) {
                        console.log('开发模式验证码:', result.code);
                    }

                    // 开始倒计时
                    sendCodeCountdown = 60;
                    const countdown = setInterval(() => {
                        sendCodeCountdown--;
                        btn.textContent = `${sendCodeCountdown}s`;
                        if (sendCodeCountdown <= 0) {
                            clearInterval(countdown);
                            btn.textContent = 'Send Code';
                            btn.disabled = false;
                        }
                    }, 1000);
                } else {
                    showToast(result.message || 'Failed to send code', 'error');
                    btn.textContent = 'Send Code';
                    btn.disabled = false;
                }
            } catch (error) {
                showToast('Failed to send: ' + error.message, 'error');
                btn.textContent = 'Send Code';
                btn.disabled = false;
            }
        }

        // 注册
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const code = document.getElementById('register-code').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (!username || !email || !code || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'warning');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            // 密码强度检查
            if (password.length < 8) {
                showToast('Password must be at least 8 characters', 'warning');
                return;
            }
            if (!/[a-zA-Z]/.test(password)) {
                showToast('Password must contain letters', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, code })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Registration successful! Please login', 'success');
                    switchToLogin();
                    // 清空表单
                    document.getElementById('register-username').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-code').value = '';
                    document.getElementById('register-password').value = '';
                    document.getElementById('register-confirm-password').value = '';
                } else {
                    showToast(result.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showToast('Registration failed: ' + error.message, 'error');
            }
        }

        // 登录
        async function handleLogin() {
            const username = document.getElementById('login-account').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Welcome back, ${result.data.username}!`, 'success');
                    toggleLogin(false);

                    // 更新登录状态
                    isLoggedIn = true;
                    currentUser = result.data;
                    updateLoginUI();
                    updateLoginOverlay();

                    // 清空表单
                    document.getElementById('login-account').value = '';
                    document.getElementById('login-password').value = '';

                    // 应用用户配置
                    if (result.data.config) {
                        applyUserConfig(result.data.config);
                    }
                } else {
                    showToast(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Login failed: ' + error.message, 'error');
            }
        }

        // 登出
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/api/auth/logout/`, { method: 'POST' });
                showToast('Logged out successfully', 'success');
            } catch (error) {
                console.error('登出失败:', error);
            }

            // 重置登录状态
            isLoggedIn = false;
            currentUser = null;
            updateLoginUI();
            updateLoginOverlay();
        }

        // 应用用户配置
        function applyUserConfig(config) {
            const { filter_config, whitelist_config, ui_config } = config;

            // 应用白名单配置
            if (whitelist_config) {
                document.getElementById('high-like').value = whitelist_config.high_like_threshold;
                document.getElementById('high-like-value').innerText = whitelist_config.high_like_threshold;
                document.getElementById('high-reply').value = whitelist_config.high_reply_threshold;
                document.getElementById('high-reply-value').innerText = whitelist_config.high_reply_threshold;
            }

            // 应用过滤配置
            if (filter_config) {
                const chineseRatio = Math.round(filter_config.min_chinese_ratio * 100);
                document.getElementById('chinese-ratio').value = chineseRatio;
                document.getElementById('chinese-ratio-value').innerText = chineseRatio + '%';

                const qualityScore = Math.round(filter_config.min_quality_score * 100);
                document.getElementById('quality-score').value = qualityScore;
                document.getElementById('quality-score-value').innerText = (filter_config.min_quality_score).toFixed(2);

                document.getElementById('char-repeat').value = filter_config.max_char_repeat;
                document.getElementById('char-repeat-value').innerText = filter_config.max_char_repeat;

                document.getElementById('dedup-method').value = filter_config.dedup_method;
            }

            // 应用UI配置
            if (ui_config) {
                document.getElementById('bg-color').value = ui_config.background_color;
                document.getElementById('bg-color-value').innerText = ui_config.background_color;

                const opacityPercent = Math.round(ui_config.opacity * 100);
                document.getElementById('opacity').value = opacityPercent;
                document.getElementById('opacity-value').innerText = opacityPercent + '%';

                // 立即应用UI设置
                applyUISettings();
            }
        }

        // 页面加载时加载配置和检查登录状态
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            checkLoginStatus();
        });
    </script>
</body>
</html>
